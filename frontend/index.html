<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Staking + Governance Demo</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .section h2 {
            color: #555;
            margin-top: 0;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .input-group {
            margin: 10px 0;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .balance {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .governance-card {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9ff;
        }
        
        .proposal {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .vote-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .vote-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .vote-for {
            background: #28a745;
            color: white;
        }
        
        .vote-against {
            background: #dc3545;
            color: white;
        }
        
        .vote-abstain {
            background: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Liquid Staking + Governance Demo</h1>
        
        <div id="connection-status" class="status info">
            <strong>Status:</strong> <span id="status-text">Connecting to wallet...</span>
        </div>
        
        <div class="section">
            <h2>üí∞ Liquid Staking</h2>
            <div class="balance">
                <strong>Your Asset Balance:</strong> <span id="asset-balance">0</span> TA
            </div>
            <div class="balance">
                <strong>Your LST Balance:</strong> <span id="lst-balance">0</span> LST
            </div>
            <div class="balance">
                <strong>Exchange Rate:</strong> <span id="exchange-rate">1.0</span>
            </div>
            
            <div class="input-group">
                <label for="deposit-amount">Deposit Amount (TA):</label>
                <input type="number" id="deposit-amount" placeholder="1000" step="0.01">
            </div>
            <button onclick="deposit()">Deposit Assets</button>
            <button onclick="initiateWithdrawal()">Initiate Withdrawal</button>
            <button onclick="claimWithdrawal()">Claim Withdrawal</button>
        </div>
        
        <div class="section">
            <h2>üèõÔ∏è Governance</h2>
            <div class="governance-card">
                <h3>Current Proposal</h3>
                <div id="proposal-info">
                    <p><strong>Description:</strong> Update unbonding period to 14 days</p>
                    <p><strong>Status:</strong> <span id="proposal-status">Active</span></p>
                    <p><strong>Your Voting Power:</strong> <span id="voting-power">0</span></p>
                </div>
                
                <div class="vote-buttons">
                    <button class="vote-btn vote-for" onclick="vote(1)">Vote For</button>
                    <button class="vote-btn vote-against" onclick="vote(0)">Vote Against</button>
                    <button class="vote-btn vote-abstain" onclick="vote(2)">Abstain</button>
                </div>
            </div>
            
            <button onclick="createProposal()">Create New Proposal</button>
            <button onclick="executeProposal()">Execute Proposal</button>
        </div>
        
        <div class="section">
            <h2>üìä System Status</h2>
            <div id="system-status">
                <p><strong>Total Assets:</strong> <span id="total-assets">0</span> TA</p>
                <p><strong>Total Shares:</strong> <span id="total-shares">0</span> LST</p>
                <p><strong>Active Withdrawals:</strong> <span id="active-withdrawals">0</span></p>
            </div>
        </div>
    </div>

    <script>
        // Contract addresses (loaded from deployments.json)
        const CONTRACTS = {
            MockERC20: "0xa513E6E4b8f2a923D98304ec87F64353C4D5C853",
            LiquidStakingVault: "0x8A791620dd6260079BF849Dc5567aDC3F2FdC318",
            GovernanceRootPublisher: "0xB7f8BC63BbcaD18155201308C8f3540b07f84F5e",
            VoteVerifier: "0xA51c1fc2f0D1a1b8494Ed1FE312d7C3a78Ed91C0",
            GovernanceExecutor: "0x0DCd1Bf9A1b36cE34237eEaFef220932846BCD82"
        };
        
        let provider, signer, contracts = {};
        
        // Initialize the application
        async function init() {
            try {
                // Check if MetaMask is installed
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    signer = provider.getSigner();
                    
                    document.getElementById('status-text').textContent = 'Connected to MetaMask';
                    document.getElementById('connection-status').className = 'status success';
                    
                    // Load contract addresses from deployments.json
                    await loadContractAddresses();
                    
                    // Initialize contracts
                    await initializeContracts();
                    
                    // Load initial data
                    await loadBalances();
                    await loadSystemStatus();
                    
                } else {
                    document.getElementById('status-text').textContent = 'MetaMask not found. Please install MetaMask.';
                    document.getElementById('connection-status').className = 'status error';
                }
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('status-text').textContent = 'Connection failed: ' + error.message;
                document.getElementById('connection-status').className = 'status error';
            }
        }
        
        // Load contract addresses from deployments.json
        async function loadContractAddresses() {
            try {
                const response = await fetch('/deployments.json');
                const deployments = await response.json();
                Object.assign(CONTRACTS, deployments.contracts);
            } catch (error) {
                console.error('Failed to load contract addresses:', error);
            }
        }
        
        // Initialize contract instances
        async function initializeContracts() {
            // MockERC20 ABI (simplified)
            const erc20ABI = [
                "function balanceOf(address) view returns (uint256)",
                "function approve(address,uint256) returns (bool)",
                "function transfer(address,uint256) returns (bool)"
            ];
            
            // LiquidStakingVault ABI (simplified)
            const vaultABI = [
                "function deposit(uint256,address) returns (uint256)",
                "function balanceOf(address) view returns (uint256)",
                "function convertToAssets(uint256) view returns (uint256)",
                "function exchangeRate() view returns (uint256)",
                "function totalAssets() view returns (uint256)",
                "function totalShares() view returns (uint256)",
                "function initiateWithdraw(uint256) returns (uint256)",
                "function claim(uint256)",
                "function getVotingPower(address,uint256) view returns (uint256)"
            ];
            
            // Initialize contracts
            contracts.asset = new ethers.Contract(CONTRACTS.MockERC20, erc20ABI, signer);
            contracts.vault = new ethers.Contract(CONTRACTS.LiquidStakingVault, vaultABI, signer);
        }
        
        // Load user balances
        async function loadBalances() {
            try {
                const userAddress = await signer.getAddress();
                
                // Load asset balance
                const assetBalance = await contracts.asset.balanceOf(userAddress);
                document.getElementById('asset-balance').textContent = ethers.utils.formatEther(assetBalance);
                
                // Load LST balance
                const lstBalance = await contracts.vault.balanceOf(userAddress);
                document.getElementById('lst-balance').textContent = ethers.utils.formatEther(lstBalance);
                
                // Load exchange rate
                const exchangeRate = await contracts.vault.exchangeRate();
                document.getElementById('exchange-rate').textContent = ethers.utils.formatEther(exchangeRate);
                
                // Load voting power
                const votingPower = await contracts.vault.getVotingPower(userAddress, await provider.getBlockNumber());
                document.getElementById('voting-power').textContent = ethers.utils.formatEther(votingPower);
                
            } catch (error) {
                console.error('Failed to load balances:', error);
            }
        }
        
        // Load system status
        async function loadSystemStatus() {
            try {
                const totalAssets = await contracts.vault.totalAssets();
                const totalShares = await contracts.vault.totalShares();
                
                document.getElementById('total-assets').textContent = ethers.utils.formatEther(totalAssets);
                document.getElementById('total-shares').textContent = ethers.utils.formatEther(totalShares);
                
            } catch (error) {
                console.error('Failed to load system status:', error);
            }
        }
        
        // Deposit assets
        async function deposit() {
            try {
                const amount = document.getElementById('deposit-amount').value;
                if (!amount || amount <= 0) {
                    alert('Please enter a valid amount');
                    return;
                }
                
                const amountWei = ethers.utils.parseEther(amount);
                
                // Approve vault to spend assets
                const approveTx = await contracts.asset.approve(CONTRACTS.LiquidStakingVault, amountWei);
                await approveTx.wait();
                
                // Deposit assets
                const depositTx = await contracts.vault.deposit(amountWei, await signer.getAddress());
                await depositTx.wait();
                
                alert('Deposit successful!');
                await loadBalances();
                await loadSystemStatus();
                
            } catch (error) {
                console.error('Deposit failed:', error);
                alert('Deposit failed: ' + error.message);
            }
        }
        
        // Initiate withdrawal
        async function initiateWithdrawal() {
            try {
                const lstBalance = await contracts.vault.balanceOf(await signer.getAddress());
                if (lstBalance.eq(0)) {
                    alert('No LST tokens to withdraw');
                    return;
                }
                
                const withdrawTx = await contracts.vault.initiateWithdraw(lstBalance);
                const receipt = await withdrawTx.wait();
                
                // Extract NFT ID from events (simplified)
                const nftId = receipt.events[0].args.tokenId;
                
                alert(`Withdrawal initiated! NFT ID: ${nftId}. You can claim after 7 days.`);
                await loadBalances();
                
            } catch (error) {
                console.error('Withdrawal initiation failed:', error);
                alert('Withdrawal initiation failed: ' + error.message);
            }
        }
        
        // Claim withdrawal
        async function claimWithdrawal() {
            try {
                // In a real implementation, you'd need to get the NFT ID
                // For demo purposes, we'll use a placeholder
                alert('Please use the CLI scripts to claim withdrawals with specific NFT IDs');
                
            } catch (error) {
                console.error('Claim failed:', error);
                alert('Claim failed: ' + error.message);
            }
        }
        
        // Vote on proposal
        async function vote(support) {
            try {
                alert(`Voting ${support === 1 ? 'FOR' : support === 0 ? 'AGAINST' : 'ABSTAIN'} on proposal. In a real implementation, this would use EIP-712 signatures.`);
                
                // In a real implementation, you would:
                // 1. Create EIP-712 signature
                // 2. Generate Merkle proof for voting power
                // 3. Submit vote to VoteVerifier contract
                
            } catch (error) {
                console.error('Vote failed:', error);
                alert('Vote failed: ' + error.message);
            }
        }
        
        // Create proposal
        async function createProposal() {
            try {
                alert('Creating proposal... In a real implementation, this would create a new governance proposal.');
                
                // In a real implementation, you would:
                // 1. Encode action data
                // 2. Create proposal on GovernanceRootPublisher
                // 3. Publish voting power root
                
            } catch (error) {
                console.error('Proposal creation failed:', error);
                alert('Proposal creation failed: ' + error.message);
            }
        }
        
        // Execute proposal
        async function executeProposal() {
            try {
                alert('Executing proposal... In a real implementation, this would execute the governance proposal.');
                
                // In a real implementation, you would:
                // 1. Check if proposal passed on VoteVerifier
                // 2. Commit action data hash
                // 3. Execute on GovernanceExecutor
                
            } catch (error) {
                console.error('Proposal execution failed:', error);
                alert('Proposal execution failed: ' + error.message);
            }
        }
        
        // Initialize the application when the page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
